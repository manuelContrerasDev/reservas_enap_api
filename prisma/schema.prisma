generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --------------------------------------
// MODULO USUARIOS
// --------------------------------------

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  emailDomain  String?
  emailLocked  Boolean  @default(false)

  passwordHash String
  name         String?
  rut          String?
  role         Role     @default(EXTERNO)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  emailConfirmed      Boolean   @default(false)
  emailConfirmToken   String?   @unique
  emailConfirmExpires DateTime?

  resetTokens PasswordResetToken[]

  reservas Reserva[] @relation("ReservasPorUsuario")
  reservasCreadas Reserva[] @relation("ReservasCreadasPorAdmin")

  auditLogs AuditLog[]
  movimientosTesoreria MovimientoTesoreria[]

  @@index([role])
  @@index([emailDomain])
}


model PasswordResetToken {
  token     String    @id
  userId    String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id])

  @@index([userId, expiresAt])
}

// --------------------------------------
// MODULO ESPACIOS
// --------------------------------------

model EspacioTipoConfig {
  id        String     @id @default(uuid())
  tipo      TipoEspacio @unique

  // =========================
  // Cat√°logo / UX
  // =========================
  titulo       String
  descripcion  String
  imagenes     Json        // string[]
  visible      Boolean     @default(true)
  deletedAt    DateTime?

  // =========================
  // Inventario l√≥gico
  // =========================
  unidadesTotales Int?     // CABANA / QUINCHO
  cupoTotal       Int?     // PISCINA (100)

  // =========================
  // Modalidad (FIJA POR TIPO)
  // =========================
  modalidadCobro ModalidadCobro

  // =========================
  // Capacidades (ADMIN)
  // =========================
  capacidadSocio       Int?
  capacidadExterno     Int?
  capacidadComun       Int?
  capacidadAlojamiento Int?
  maximoAbsoluto       Int?

  // =========================
  // Precios base
  // =========================
  precioBaseSocio   Int
  precioBaseExterno Int

  // =========================
  // Extras por invitado
  // =========================
  precioExtraSocio   Int
  precioExtraExterno Int

  // =========================
  // Piscina
  // =========================
  precioPiscinaSocio   Int?
  precioPiscinaExterno Int?
  freePiscinaSocio     Int?   // ej: 5

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tipo, visible])
}


model Espacio {
  id             String         @id @default(uuid())
  nombre         String
  tipo           TipoEspacio
  descripcion    String?
  imagenUrl      String?

  capacidad      Int

  // Estado y visibilidad
  activo         Boolean        @default(true)
  visible        Boolean        @default(true)
  orden          Int            @default(0)

  modalidadCobro ModalidadCobro @default(POR_NOCHE)

  // --- TARIFAS BASE (Por Noche / D√≠a) ---
  precioBaseSocio   Int @default(0)
  precioBaseExterno Int @default(0)

  // --- TARIFAS POR PERSONA ADICIONAL ---
  precioPersonaAdicionalSocio   Int @default(3500)
  precioPersonaAdicionalExterno Int @default(4500)

  // --- TARIFAS PISCINA ---
  precioPiscinaSocio   Int @default(3500)
  precioPiscinaExterno Int @default(4500)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  reservas Reserva[]

  @@index([tipo, activo])
  @@index([visible])
}

// --------------------------------------
// MODULO RESERVAS
// --------------------------------------

model Reserva {
  id        String @id @default(uuid())
  userId    String

  // ============================================================
  // üß© PRODUCTO RESERVADO (CONTRATO)
  // ============================================================
  tipoEspacio TipoEspacio   // CABANA | QUINCHO | PISCINA

  // ============================================================
  // üè† UNIDAD ASIGNADA (LEGACY / INTERNO)
  // ============================================================
  espacioId String?         // NULL para piscina
  espacio   Espacio? @relation(fields: [espacioId], references: [id])

  // ============================================================
  // ‚è±Ô∏è FECHAS
  // ============================================================
  fechaInicio DateTime
  fechaFin    DateTime
  dias        Int

  expiresAt DateTime?

  // ============================================================
  // üîê USO Y ESTADO
  // ============================================================
  usoReserva UsoReserva    @default(USO_PERSONAL)
  estado     ReservaEstado @default(PENDIENTE_PAGO)

  // ============================================================
  // üìá DATOS CONTACTO
  // ============================================================
  nombreSocio    String
  rutSocio       String
  telefonoSocio  String
  correoEnap     String?
  correoPersonal String?

  nombreResponsable    String?
  rutResponsable       String?
  emailResponsable     String?
  telefonoResponsable  String?

  // ============================================================
  // üë• CANTIDADES (SNAPSHOT)
  // ============================================================
  cantidadAdultos Int @default(1)
  cantidadNinos   Int @default(0)
  cantidadPiscina Int @default(0)

  // ============================================================
  // üí∞ SNAPSHOTS FINANCIEROS
  // ============================================================
  precioBaseSnapshot    Int @default(0)
  precioPersonaSnapshot Int @default(0)
  precioPiscinaSnapshot Int @default(0)
  totalClp              Int

  // ============================================================
  // ‚ùå AUDITOR√çA
  // ============================================================
  cancelledAt DateTime?
  cancelledBy CancelledBy?

  // ============================================================
  // üí≥ PAGO MANUAL
  // ============================================================
  comprobanteUrl   String?
  comprobanteName  String?
  comprobanteMime  String?
  comprobanteSize  Int?

  confirmedAt DateTime?
  confirmedBy String?

  terminosAceptados Boolean @default(false)
  terminosVersion   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ============================================================
  // üîó RELACIONES
  // ============================================================
  creadaPor    String?
  adminCreador User? @relation("ReservasCreadasPorAdmin", fields: [creadaPor], references: [id])

  invitados Invitado[]
  pago      Pago?
  movimientosTesoreria MovimientoTesoreria[]
  user      User @relation("ReservasPorUsuario", fields: [userId], references: [id])

  // ============================================================
  // ‚ö° √çNDICES
  // ============================================================
  @@index([estado])
  @@index([fechaInicio, fechaFin])
  @@index([tipoEspacio, fechaInicio, fechaFin])   // üîë CLAVE PARA DISPONIBILIDAD
  @@index([userId, createdAt])
  @@index([estado, expiresAt])
}

model Invitado {
  id        String  @id @default(uuid())
  reservaId String
  nombre    String
  rut       String
  edad      Int?
  esPiscina Boolean @default(false)

  reserva Reserva @relation(fields: [reservaId], references: [id])

  @@index([reservaId])
}

// --------------------------------------
// MODULO PAGOS
// --------------------------------------

model Pago {
  id        String @id @default(uuid())
  reservaId String @unique

  // WebPay Identifiers
  buyOrder  String  @unique // IMPORTANTE: @unique para seguridad
  token     String? @unique
  sessionId String?

  provider  String
  amountClp Int
  status    PaymentStatus @default(CREATED)

  authorizationCode String?
  transactionDate   String?
  paymentTypeCode   String?
  responseCode      Int?
  rawResponse       Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  reserva Reserva @relation(fields: [reservaId], references: [id])

  @@index([status])
  @@index([buyOrder])
}

// --------------------------------------
// MODULO TESORERIA (PAGOS VALIDADOS)
// --------------------------------------
model MovimientoTesoreria {
  id          String     @id @default(uuid())

  reservaId   String
  reserva     Reserva    @relation(fields: [reservaId], references: [id], onDelete: Restrict)

  montoClp    Int
  metodo      MetodoPago @default(TRANSFERENCIA)

  referencia  String?
  nota        String?

  creadoPorId String
  creadoPor   User       @relation(fields: [creadoPorId], references: [id], onDelete: Restrict)

  createdAt   DateTime   @default(now())

  @@index([reservaId])
  @@index([creadoPorId])
  @@index([createdAt])
}


// --------------------------------------
// MODULO LOGS
// --------------------------------------

model AuditLog {
  id        String   @id @default(uuid())
  action    String
  entity    String
  entityId  String
  userId    String?
  details   Json?
  ipAddress String?
  createdAt DateTime @default(now())
  before Json?
  after  Json?

  // Relaci√≥n
  user User? @relation(fields: [userId], references: [id])

  @@index([entity, createdAt])
  @@index([action, createdAt])
  @@index([userId, createdAt])
}


// --------------------------------------
// MODEL LUNES EXCEPCION
// --------------------------------------

model LunesExcepcion {
  id        String   @id @default(uuid())
  fecha     DateTime @unique
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())

  @@index([fecha])
}


// --------------------------------------
// ENUMS
// --------------------------------------

enum TipoEspacio {
  CABANA
  QUINCHO
  PISCINA
}

enum Role {
  ADMIN
  SOCIO
  EXTERNO
}

enum ModalidadCobro {
  POR_NOCHE
  POR_DIA
  POR_PERSONA
}

enum UsoReserva {
  USO_PERSONAL
  CARGA_DIRECTA
  TERCEROS
}

enum ReservaEstado {
  PENDIENTE_PAGO        // creada, SIN comprobante
  PENDIENTE_VALIDACION  // comprobante subido, esperando ADMIN
  CONFIRMADA            // validada por ADMIN
  RECHAZADA             // ADMIN rechaza comprobante (motivo obligatorio)
  CADUCADA              // sistema (timeout)
  FINALIZADA            // reserva cumplida (post fechaFin)
}

enum PaymentStatus {
  CREATED
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum MetodoPago {
  TRANSFERENCIA
}

enum CancelledBy {
  USER
  ADMIN
  SYSTEM
}
